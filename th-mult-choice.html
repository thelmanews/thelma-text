<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../thelma-core/thelma_core.html">
<script src="../web-animations-js/web-animations.js"></script> 

<!--
Element providing a multiple choice quiz

@element th-mult-choice
@blurb Element providing a multiple choice quiz
@status alpha
@homepage http://github.com/thelmanews/thelma-text/blob/master/th-mult-choice.html
-->

<polymer-element name="th-mult-choice" attributes="width height question answerText choices">
  <template>
      <core-style ref="theme"></core-style>
      <style>
        :host {
          position: relative;
          display: inline-block;
          width: {{width + "px"}};
          height: {{height + "px"}};
        }

        .img-choice {
          /*height: {{choiceSize + "px"}};*/
          /*width: {{choiceSize + "px"}};*/
          margin: 0 auto;
          /*border-radius: {{choiceSize/2 + "px"}};*/
          background-size: cover;
          padding-top: 5%;
          box-sizing: border-box;
          /*border: 4px solid {{foreground1}};*/
        }

        .selected .img-choice {
          /*box-shadow: {{"inset 0 0 0 45px rgba("+rgb+", 0.5)"}};*/
          box-shadow: inset 0 0 0 45px rgba(255,255,255, 0.5);
        }

        .selected .img-choice:before {
          font-size: {{choiceSize/2 + "px"}};
          content: '\2714';
          color: {{foreground}};
        }

        li {
          display: inline-block;
          list-style: none;
          margin: 0;
          padding: 0;
          text-align: center;
          position: relative;
          float: left;
        }

        .release .img-choice {
          -webkit-transition: all 1s ease-in-out 0s;
          -moz-transition: all 1s ease-in-out 0s;
          -o-transition: all 1s ease-in-out 0s;
          -ms-transition: all 1s ease-in-out 0s;
          transition: all 1s ease-in-out 0s;
          box-shadow: inset 0 0 0 0 rgba(255,255,255, 0.5);
          /*box-shadow: {{"inset 0 0 0 0 rgba("+rgb+", 0.5)"}};*/
        }

        .hold .img-choice { 
          -webkit-transition: all 1s ease-in-out 0s;
          -moz-transition: all 1s ease-in-out 0s;
          -o-transition: all 1s ease-in-out 0s;
          -ms-transition: all 1s ease-in-out 0s;
          transition: all 1s ease-in-out 0s;
          box-shadow: inset 0 0 0 45px rgba(255,255,255, 0.5);
          /*box-shadow: {{"inset 0 0 0 45px rgba("+rgb+", 0.5)"}};*/
        }

        .flash {
          font-size: 20px;
          -webkit-animation-name: flash;
          -webkit-animation-duration: 3s;
          -webkit-animation-timing-function: ease-out; 
          -webkit-animation-iteration-count: 1; 
          opacity: 0;
          text-align: center;
          position: absolute;
          bottom: {{choiceSize * 0.8 + "px"}};
          display: block;
          width: 100%;
          text-shadow: 0px 0px 30px rgba(0, 0, 0,1);
        }

        @-webkit-keyframes flash {
           0% {-webkit-transform: scale(1, 1); opacity: 0.0;}
           40% {-webkit-transform: scale(1,1); opacity: 1.0; }
           60% {-webkit-transform: scale(1,1); opacity: 1.0; }
           100% {-webkit-transform: scale(1, 1); opacity: 0.0;}
        }
    
      </style>
      <div id="container">
          
            <div id="question" style="z-index: 3; position: absolute;">
              <p class="headline">{{question}}</p>
              <template if="{{tapped}}"> <p class="flash">Please press and hold</p> </template>
              <div class="choices">
              <template repeat="{{choice in choices}}">
                <li on-tap={{tap}} on-holdpulse={{hold}} on-release={{release}} style="width:{{_choiceWidth}}px;">
                    <div class="img-choice release"  style=" background-image: url('{{choice.image}}'); height: {{choiceSize}}px; width: {{choiceSize }}px; border-radius: {{choiceSize/2}}px; border: 4px solid {{foreground1}};">
                      <div class="overlay"></div>
                    </div>
                    <template if="{{choice.text}}">
                      <p class="label">{{choice.text}}</p>
                    </template>
                </li>
              </template>
              </div>
            </div>

            <div id="answer" style="opacity:0; position: absolute; z-index: 1;">
              <p class="headline">{{answerText}}</p>
              <template repeat="{{ choice in choices | answerFilter }}">
              <li class="show" style="width:{{width/numAnswers}}px">
                <div class="img-choice" style="background-image: url('{{choice.image}}'); height: {{choiceSize}}px; width: {{choiceSize }}px; border-radius: {{choiceSize/2}}px; border: 4px solid {{foreground1}};">
                  <div class="overlay"></div>
                </div>
                <p class="label">{{choice.text}}</p>
              </li>
              </template>
            </div>
      </div>
  </template>




  <script>
      Polymer('th-mult-choice', {
        /**
         * The 'question' attribute stores the question text.
         * @type {String}
         */
        question: "Which asd asd ad ad ada done would you choose?",

        /**
         * The 'choices' attribute specifies all the answer choices
         * @type {Array}
         */
        choices: [
          {'text': 'Twitter', 'image':'images/twitter.jpg', 'answer': false},
          {'text': 'Facebook', 'image':'images/person.jpg', 'answer': true},
          {'text': 'Facebook', 'image':'images/person.jpg', 'answer': false},
          {'text': 'Facebook', 'image':'images/person.jpg', 'answer': false}
        ],
        /** 
         * The 'width' attribute specifies the width of the component in pixels.
         * @type {Number}
         */
        width: 280,

        /** 
         * The 'height' attribute specifies the height of the component in pixels.
         * @type {Number}
         */
        height: 280,

        /**
         * The 'answerText' attribute specifies the text that prefaces the correct answer(s).
         * @type {String}
         */
        answerText: "The correct answer is:",
        /**
         * The 'choicesPerRow' attribute specifies the number of choices to be displayed in each row
         * @type {Number}
         */
        choicesPerRow: 2,
        ready: function(){
          var self = this;
          self._choiceWidth = self.width / self.choicesPerRow;

        },
        domReady: function(){
          var self = this;
          self.numTaps = 0;
          self.setColors();
          self.answered = false;
          self.choiceSize = Math.round((self.width / self.choicesPerRow ) * 0.7);
          self.answersSelected = 0;
          self.numAnswers = self.choices.filter(function(choice){
            return choice.answer;
          }).length;


         
        },
        /**
         * The 'setColors' method detects the theme and chooses the correct colors. It also converts the theme color into RGB format to be applied in RGBA format in CSS
         */
        setColors: function(){
          var self = this;
          self.foreground = window.CoreStyle.g.theme.foreground1;
          self.themecolor = window.CoreStyle.g.theme.accent1;
          
          // Convert theme hexcode to RGB to be used as semi-transparent inset shadow
          self.rgb = (function(){
            var result =  /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(self.themecolor);
              return result ? 
                (parseInt(result[1], 16)+","+parseInt(result[2], 16)+","+parseInt(result[3], 16)) : "0,0,0";
          })();
        },

        /**
         * The 'tap' method is called when user attempts to tap an answer choice, and displays a flash message for 4 seconds instructing user to hold selection.
         * @param  {object} e         e is the event object.
         * @param  {object} detail    detail is event detail.
         * @param  {object} selection selection is the node tapped.
         */
        tap: function(e, detail, selection){
          var self = this;
          console.log("tap");
          if ((selection.className != "selected") && (self.numTaps < 1)){
            self.tapped = true;
            self.numTaps++;
          }
          setTimeout(function(){
            self.tapped = false;
          }, 4000)
        },
        /**
         * The 'hold' method is called when user holds down a selection and records the holdTime.
         * @param  {object} e         e is the event object.
         * @param  {object} detail    detail is event detail.
         * @param  {object} selection selection is the node tapped.
         */
        hold: function(e, detail, selection){
          var self = this;
          console.log("hold");
          selection.className = "hold"; // This triggers the fill styling.
          self.holdTime = e.holdTime;
        },
        /**
         * The 'release' method is called when user releases the selection. If an answer was selected, it calls the 'selectAnswer' method.
         * @param  {object} e         e is the event object.
         * @param  {object} detail    detail is event detail.
         * @param  {object} selection selection is the node tapped.
         */
        release: function(e, detail, selection){
          var self = this;
                    console.log("release");

          selection.className = "release";
          
          if (self.holdTime > 1200) {
            self.answersSelected++;
            self.selectAnswer(selection);
          }
        },
        /**
         * The 'selectAnswer' method displays the check mark on the choice and calls showAnswer if the correct number of answers have been chosen.
         * @param  {object} selection selection is the node selected.
         */
        selectAnswer: function(selection){
          var self = this;
          selection.className = "selected";
          if (self.answersSelected == self.numAnswers){
            self.showAnswer();
          }
        },
        /**
         * The 'showAnswer' method calls the animate method on the carousel to display the answer panel.
         * @return {[type]} [description]
         */
        showAnswer: function(){
          var self = this;

          var fadeOut = new Animation(self.$.question, [
                {opacity: "1"}, 
                {opacity: "0"}
              ],
              { duration: 2000, delay: 1000, fill: "forwards" });
          var fadeIn = new Animation(self.$.answer, [
                {opacity: "0"}, 
                {opacity: "1"}
              ],
              { duration: 2000, fill: "forwards" });

          document.timeline.play(new AnimationSequence([fadeOut, fadeIn]))
         
        },
        /**
         * The 'answerFilter' method called from the template filters out only the choices marked 'answer: true' to be displayed in answer div.
         * @param  {Array} value  passed from template
         * @return {Object}       returns answers, an array of choices  with answer: true
         */
        answerFilter: function(value){
          var answers = value.filter(function(choice){
            return choice.answer == true;
          })
          return answers;
        },
        /**
         * The 'reset' method checks to see if the answer panel is showing, and if so, animates the carousel to return to the question panel.
         */
        reset: function(){
          var self = this;
          if (self.answered){
            self.$.carousel.animate();
          }
        }
      });
  </script>
</polymer-element>