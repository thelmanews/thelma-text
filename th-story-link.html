<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="thelma_core.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="th-story-link" attributes="width url title image theme">
  <template>
      <core-style ref="theme"></core-style>
      <style>
        :host{
          width: {{width}}
        }

        a {
          text-decoration: none;
        }

        li {
          list-style: none;
          font-size: 0.8em;
          font-weight: 300;
          -webkit-background-size: cover;
          -moz-background-size: cover;
          -o-background-size: cover;
          background-size: cover;
          color: {{color}};
          border-bottom: 2px solid {{bordercolor}};
         }

        .layer {
          background-color: {{bgcolor}};
          width: 100%;
          height: 100%;
          padding: 8px;
          box-sizing: border-box;
        }

        .title {
          margin: 4px 0px 0px 0px;
          display: -webkit-box;
          -webkit-box-orient: vertical;    
          -webkit-line-clamp: 2;
          overflow: hidden;        
        }

        .favicon {
          display: inline-block;
          position: absolute;
          bottom: 3px;
          right: 3px;
          width: 16px;
          height: 16px;
          border-radius: 8px;
          text-align: center;
        }

        .favicon:before {
          content: "\0074"; /* replace with correct thelma unicode symbol */
        }

      </style>
      <core-ajax id="parse"
        url={{requestUrl}}
        handleAs="text"  
        on-core-response="{{parseResponse}}">
      </core-ajax>

      <core-ajax id="load"
        url={{loadUrl}}
        handleAs="json"  
        on-core-response="{{loadResponse}}">
      </core-ajax>

      <core-ajax id="save"
        url={{saveUrl}}
        handleAs="json"  
        method="POST"
        on-core-response="{{saveResponse}}">
      </core-ajax>

      <!-- DON'T KNOW WHY BUT IF THIS IS NOT HERE, IT BREAKS -->
      <div style="display:none;">{{image}}</div>
      <!-- -->

      <template if="{{title}}">
        <a href={{url}} target="_blank">
          <li style="background: url({{image}}) center center no-repeat; background-size: cover;"> 
            <div class="layer">
              <content></content>
              <p class="title headline">{{title}}</p>
              <template if={{thelma}}> <span class="favicon"></span> </template>
            </div>
          </li>
        </a>
      </template>
  </template>

  <script>
      Polymer('th-story-link', {
        ready: function(){
          var self = this;
          self.requestUrl = self.url.replace(/(ftp|http|https):\/\//,'http://www.corsproxy.com/');
          
          // Check if it's a thelma story for favicon
          self.thelma = /.*thelma.*/.test(self.url);

          // Set styles based on light or dark theme
          self.color = self.theme == "light" ? "black" : "white";
          self.bgcolor = self.theme == "light" ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.5)";
          self.bordercolor = self.theme == "light" ? "rgba(0,0,0,0.5)" : "rgba(255,255,255,0.5)";

          self.init();
          
        },
        init: function(){
          var self = this;
         
          self.$.parse.go();
         
          // If there is no title or image for the url, load it from the DB
          if(!self.title || !self.image){
            // self.loadData();
          }

          
        },
        parseResponse: function(event, r) {
          var self = this,
              response = r.response,
              // These matches work when content is listed after the name in the meta tag only.
              titleMatch = response.match(/"twitter:title"\s*content=\s*"(.*)"/) || response.match(/"og:title"\s*content=\s*"(.*)"/), 
              imgMatch = response.match(/"twitter:image"\s*content=\s*"(.*)"/) || response.match(/"og:image"\s*content=\s*"(.*)"/);
              // descMatch = response.match(/"twitter:description"\s*content=\s*"(.*)"/) || response.match(/"og:description"\s*content=\s*"(.*)"/),
          
          self.title = titleMatch ? titleMatch[1] : "";
          self.image = imgMatch ? imgMatch[1] : "";
          // self.description = descMatch ? descMatch[1] : "";

          if(self.title && self.image){
            self.saveData();
          }
        },
        requestLoad: function(){
          var self = this;
          self.asyncFire('th-request-link-data', self.url);
          // composer should set event listener for this, fetch the data with the url, and then pass it back by calling loadData 

        },
        loadData: function(data){
          var self = this;
          if (data){
            self.title = data.title;
            self.image = data.image;
          } else {
            self.$.parse.go();
          }
        
          
          // need to pass in self.url as params...
          // this.$.load.go();
        },
        saveData: function(d){
          var self = this;
          self.saveUrl = saveUrl;

          // need to pass in self.url as params...
          this.$.save.go();
        },
        loadResponse: function(event, r){
          var self = this;
          
          if(r){
            self.title = r.title;
            self.image = r.image;
          } else {
            self.$.parse.go();
          }
        },
        saveResponse: function(){
          // 
        }
      });

  </script>
</polymer-element>

