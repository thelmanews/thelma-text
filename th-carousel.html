<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../thelma-core/thelma_core.html">
<link rel="import" href="../thelma-utils/th-theme.html">

<!--
Element providing a 3D carousel for either text or images.

##### Example

    <th-carousel>
      <div>First Slide</div>
      <div>Second Slide</div>
      <div>Third Slide</div>
      <div>Fourth Slide</div>
      <div>Fifth Slide</div>
      <div>Sixth Slide</div>
    </th-carousel>

@element th-carousel
@blurb Element providing a 3D carousel for either text or images.
@status alpha
@homepage http://aendrew.github.io/th-carousel
-->
<polymer-element name="th-carousel" extends="th-animated" attributes="items animateOn interval isHorizontal backfaces width height fontSize">

  <template>

    <core-style ref="theme"></core-style>

    <style type="text/css">
      :host section.container {
        width: {{width + "px"}};
        height: {{height + "px"}};
        position: relative;
        margin: 0 auto 40px;
       /* border: 1px solid #CCC;*/
        display: block;
        -webkit-perspective: 1100px; 
           -moz-perspective: 1100px;
             -o-perspective: 1100px;
                perspective: 1100px;
      }


      :host #carousel {
        width: 100%;
        height: 100%;
        position: absolute;
        -webkit-transform-style: preserve-3d;
           -moz-transform-style: preserve-3d;
             -o-transform-style: preserve-3d;
                transform-style: preserve-3d;

        -webkit-transition: -webkit-transform 1s;
           -moz-transition: -moz-transform 1s;
             -o-transition: -o-transform 1s;
                transition: transform 1s;

      }
      /*
      .ready works only for one component in the page
       
      :host #carousel.ready {
      }
      */
      #carousel.panels-backface-invisible ::content > *, #carousel > * {
        -webkit-backface-visibility: hidden;
           -moz-backface-visibility: hidden;
             -o-backface-visibility: hidden;
                backface-visibility: hidden;
      }

      ::content > *, #carousel > * {
        display: block;
        position: absolute;
        width: {{width + "px"}};
        left: 10px;
        top: 10px;
        vertical-align: middle;
        font-size: {{fontSize + "px"}};
        text-align: center;
        margin: 0;
      }

       ::content > *, #carousel > * {
        -webkit-transition: opacity 1s, -webkit-transform 1s;
           -moz-transition: opacity 1s, -moz-transform 1s;
             -o-transition: opacity 1s, -o-transform 1s;
                transition: opacity 1s, transform 1s;
      }

    </style>

    <section class="container">
      <div id="carousel" class="panels-backface-invisible">
        <content></content>

        <template if="{{items}}">
          <template repeat="{{item in items}}">
            <div class="panel" style="width: {{width}}px; height: {{height}}; background: {{item.image}} no-repeat cover; background-color: blue; font-size: {{fontSize}}px; -webkit-backface-visibility: hidden; "> {{item.text}} </div>
            
          </template>
        </template>

      </div>
    </section>


  </template>

  <link rel="import" href="dependencies/modernizr_dep.html">


  <script>

    Polymer('th-carousel', {
      /**
       * The `isHorizontal` attribute chooses orientation.
       *
       * @attribute isHorizontal
       * @type boolean
       */
      isHorizontal: true,

      /**
       * The `backfaces` attribute triggers backface visibility.
       *
       * @property backfaces
       * @type bool
       */
      backfaces: false,

      /**
       * The `rotation` property stores the current rotation angle.
       *
       * @property rotation
       * @type string
       */
      rotation: 0,

      /**
       * The `animateOn` property stores the event trigger for panel transitions
       *
       * @property rotation
       * @type string
       * @options 'tap', 'interval', 'none'
       */
      animateOn: "tap",

      /**
       * The `interval` property stores interval time between panel transitions.
       *
       * @property interval
       * @type integer
       */
      interval: 3000,

      /**
       * The `radius` property stores radius of the carousel.
       *
       * @property radius
       * @type string
       */
      radius: 0,

      /**
       * The `_panelCount` property specifies the current panel.
       *
       * @attribute _panelCount
       * @type integer
       */
      _panelCount: 0,

      /**
       * The `width` property specifies width of the component in pixels.
       *
       * @attribute width
       * @type integer
       */
      width: '300',

      /**
       * The `fontSize` property specifies fontSize in pixels.
       *
       * @attribute fontSize
       * @type integer
       */
      fontSize: '18',

      /**
       * The `_panels` property specifies the total number of panels.
       *
       * @attribute _panels
       * @type integer
       */
      _panels: 0,

      /**
       * The `theta` property specifies the interior angle of the panels.
       *
       * @property theta
       * @type integer
       */
      theta: 0,

      /**
       * The `transformProp` property returns the browser's CSS transform property.
       *
       * @property transformProp
       * @type string
       */
      // transformProp: Modernizr.prefixed('transform'),
      transformProp: "-webkit-transform",
      items: [  
                {text: "first item", image: "../thelma-all/images/person.jpg"},
                {text: "second item", image: ""},
                {text: "third item", image: ""},
                {text: "fourth item", image: ""}  
              ],

      init: function() {
        var element = this;
            carousel = this.shadowRoot.getElementById('carousel'),
            axisButton = this.shadowRoot.getElementById('toggle-axis'),
            navButtons = this.shadowRoot.querySelectorAll('#navigation button'),

            onNavButtonClick = function( event ){
              var increment = parseInt( event.target.getAttribute('data-increment') );
              element.rotation += element.theta * increment * -1;
              element.transform();
            };

        this._panels = this.children.length > 0 ? this.children : this.shadowRoot.querySelectorAll('.panel');

        if(element.backfaces) {
          carousel.classList.remove('panels-backface-invisible');
        }

        // populate on startup
        this._panelCount = this._panels.length;
        this.modify();


        setTimeout( function(){
          carousel.classList.add('ready');
        }, 0);
      },

      /**
       * The `modify` method reconfigures the carousel.
       *
       * @method modify
       * @return {Object} Returns undefined.
       */
      modify: function() {
        
        var element = this,
            panel, angle, i;
        carousel = this.shadowRoot.getElementById('carousel'),
        this.panelSize = carousel[ this.isHorizontal ? 'offsetWidth' : 'offsetHeight' ];
        this.rotateFn = this.isHorizontal ? 'rotateY' : 'rotateX';
        this.theta = 360 / this._panelCount;

        // do some trig to figure out how big the carousel
        // is in 3D space
        this.radius = Math.round( ( this.panelSize / 2) / Math.tan( Math.PI / this._panelCount ) * 0.9 );
        var elements = this.children.length > 0 ? this.children : this.shadowRoot.querySelectorAll('.panel');

        for ( i = 0; i < this._panelCount; i++ ) {
          panel = elements[i];
          if (this.animateOn == "tap"){
            panel.addEventListener('tap' ,function() {
              element.animate();
            });
          } 


          angle = this.theta * i;
          panel.style.opacity = 1;
          panel.classList.add('border');
          //panel.style.backgroundColor = 'hsla(' + angle + ', 100%, 50%, 0.8)';
          // rotate panel, then push it out in 3D space
          panel.style[ this.transformProp ] = this.rotateFn + '(' + angle + 'deg) translateZ(' + this.radius + 'px)';
        }

        if (this.animateOn == "interval"){
         setInterval(function(){
          element.animate();
         }, this.interval)
        }

        // hide other panels
        for (  ; i < this._panels; i++ ) {
          panel = elements[i];
          panel.style.opacity = 0;
          panel.style[ this.transformProp ] = 'none';
        }

        // adjust rotation so panels are always flat
        this.rotation = Math.round( this.rotation / this.theta ) * this.theta;

        this.transform();
      },

      /**
       * The `transform` method pushes the carousel back in 3D space and rotates it.
       *
       * @method transform
       * @return {Object} Returns undefined.
       */
      transform: function() {
        this.shadowRoot.getElementById('carousel').style[ this.transformProp ] = 'translateZ(-' + this.radius + 'px) ' + this.rotateFn + '(' + this.rotation + 'deg)';
      },

      animate: function() {
          this.rotation -= this.theta;
          this.transform();

      }

    });

  </script>

</polymer-element>
